<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="google" content="notranslate" />
    <title>스쿼시 강습 신청 도우미</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link href="/beer.min.css" rel="stylesheet" />
    <script type="module" src="/beer.min.js"></script>
    <script type="module" src="/material-dynamic-colors.min.js"></script>
    <style>
      #overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        z-index: 9999;
        color: #ffffff;
        text-align: center;
        font-weight: bold;
      }

      #overlay.visible {
        display: flex;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid rgba(255, 255, 255, 0.3);
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      #overlay-message {
        text-align: center;
      }
    </style>
  </head>
  <body style="zoom: 0.9">
    <main class="responsive" style="overflow: auto">
      <nav>
        <h4>스쿼시 수강 신청 도우미</h4>
      </nav>
      <div class="space"></div>
      <hr />
      <nav>
        <p class="bold">강습 신청</p>
      </nav>
      <nav>
        <fieldset>
          <legend>브라우저</legend>
          <button onclick="browserLaunch()">실행</button>
          <button onclick="browserRefresh()">새로고침</button>
          <button class="border red-text bold" onclick="browserClose()">
            ❗종료
          </button>
          <br /><br />
          <button onclick="browserRemoveWaiting()">[수동] 대기열 제거</button>
        </fieldset>
      </nav>
      <nav>
        <fieldset>
          <legend>로그인</legend>
          <div class="field border label">
            <input id="id" type="text" />
            <label>아이디</label>
          </div>
          <div class="field border label">
            <input id="password" type="password" />
            <label>비밀번호</label>
          </div>
          <button onclick="login()">로그인</button>
        </fieldset>
      </nav>
      <nav>
        <fieldset>
          <legend>강습 신청</legend>
          <div class="grid">
            <button class="s12 m2" onclick="move()">1. 신청 페이지 진입</button>
            <button class="s12 m2" onclick="action('1')">
              2. 구분 선택 (스쿼시)
            </button>
            <button class="s12 m2" onclick="action('2')">
              3. 일자 선택 (화목)
            </button>
            <button class="s12 m2" onclick="action('3')">
              4. 시간 선택 (화목 8시)
            </button>
            <button
              class="s12 m4 border small-round bold red-text"
              onclick="action('4')"
            >
              [❗경고] 원클릭 신청 (실험중)
            </button>
          </div>
        </fieldset>
      </nav>
      <nav>
        <p class="bold">화면 캡처</p>
      </nav>
      <nav>
        <button onclick="refreshScreenshot(true)">최신 화면 불러오기</button>
      </nav>
      <nav>
        <p id="screenshot-time" class="muted"></p>
      </nav>
      <nav>
        <img
          id="screenshot"
          alt="현재 브라우저 화면"
          style="width: 100%; border: 1px solid #ccc; border-radius: 8px"
        />
      </nav>
    </main>
    <div id="overlay" role="status" aria-live="polite" aria-busy="true">
      <div class="spinner" aria-hidden="true"></div>
      <div id="overlay-message">잠시만 기다려주세요...</div>
    </div>
    <script>
      const overlay = document.getElementById("overlay");
      const overlayMessage = document.getElementById("overlay-message");
      let statusSource = null;
      let statusReconnectTimer = null;
      const STATUS_RECONNECT_DELAY = 3000;
      const SESSION_COOKIE_NAME = "squash-helper-session";
      let lastStatusMessage = "잠시만 기다려주세요...";

      function showOverlay() {
        if (overlayMessage) {
          overlayMessage.textContent = lastStatusMessage;
        }
        overlay.classList.add("visible");
      }

      function hideOverlay() {
        overlay.classList.remove("visible");
      }

      function handleResponse(res) {
        return res.text().then((text) => {
          hideOverlay();
          alert(text);
          return res.ok;
        });
      }

      function updateScreenshotInfo(message) {
        const timeEl = document.getElementById("screenshot-time");
        if (timeEl) {
          timeEl.textContent = message || "";
        }
      }

      function handleStatusPayload(payload) {
        if (!payload || !payload.message) {
          return;
        }
        lastStatusMessage = payload.message;
        if (overlay.classList.contains("visible") && overlayMessage) {
          overlayMessage.textContent = lastStatusMessage;
        }
      }

      function hasActiveSession() {
        return document.cookie
          .split(";")
          .map((part) => part.trim())
          .some((part) => part.startsWith(`${SESSION_COOKIE_NAME}=`));
      }

      function cleanupStatusStream() {
        if (statusSource) {
          statusSource.close();
          statusSource = null;
        }
      }

      function scheduleStatusReconnect() {
        if (statusReconnectTimer) {
          return;
        }
        statusReconnectTimer = setTimeout(() => {
          statusReconnectTimer = null;
          setupStatusStream();
        }, STATUS_RECONNECT_DELAY);
      }

      function setupStatusStream() {
        cleanupStatusStream();
        if (statusReconnectTimer) {
          clearTimeout(statusReconnectTimer);
          statusReconnectTimer = null;
        }
        try {
          statusSource = new EventSource("/status/stream");
        } catch (err) {
          console.error("status stream init failed", err);
          scheduleStatusReconnect();
          return;
        }
        statusSource.onmessage = (event) => {
          if (!event.data) {
            return;
          }
          try {
            const payload = JSON.parse(event.data);
            handleStatusPayload(payload);
          } catch (err) {
            console.error("status event parse failed", err);
          }
        };
        statusSource.onerror = () => {
          cleanupStatusStream();
          scheduleStatusReconnect();
        };
      }

      function refreshScreenshot(showError) {
        const img = document.getElementById("screenshot");
        if (!img) {
          return;
        }
        fetch("/screenshot")
          .then((res) => {
            if (!res.ok) {
              return res.text().then((text) => {
                throw new Error(text || "화면 캡처를 불러오지 못했습니다.");
              });
            }
            return res.json();
          })
          .then((data) => {
            img.src = data.image;
            if (data.capturedAt) {
              const captured = new Date(data.capturedAt);
              updateScreenshotInfo(
                "촬영 시각: " + captured.toLocaleString("ko-KR")
              );
            } else {
              updateScreenshotInfo("최신 화면을 불러왔습니다.");
            }
          })
          .catch((err) => {
            img.removeAttribute("src");
            updateScreenshotInfo("화면 캡처를 불러오지 못했습니다.");
            if (showError) {
              alert(err.message || err);
            }
          });
      }

      function browserLaunch() {
        showOverlay();
        fetch("/launch")
          .then(handleResponse)
          .then((ok) => {
            if (ok) {
              setupStatusStream();
            }
          })
          .catch((err) => alert(err))
          .finally(() => refreshScreenshot(true));
      }

      function browserClose() {
        showOverlay();
        fetch("/close")
          .then(handleResponse)
          .catch((err) => alert(err));
      }

      function browserRefresh() {
        showOverlay();
        fetch("/refresh")
          .then(handleResponse)
          .catch((err) => alert(err))
          .finally(() => refreshScreenshot(false));
      }

      function browserRemoveWaiting() {
        showOverlay();
        fetch("/remove-waiting")
          .then(handleResponse)
          .catch((err) => alert(err))
          .finally(() => refreshScreenshot(false));
      }

      function login() {
        showOverlay();
        fetch("/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: document.getElementById("id").value,
            password: document.getElementById("password").value,
          }),
        })
          .then(handleResponse)
          .catch((err) => alert(err))
          .finally(() => refreshScreenshot(false));
      }

      function move() {
        showOverlay();
        fetch("/move")
          .then(handleResponse)
          .catch((err) => alert(err))
          .finally(() => refreshScreenshot(false));
      }

      function action(code) {
        if (code === "4") {
          if (!confirm("[특경로] 빠른 신청 (실험)\n진행하시겠습니까?")) {
            return;
          }
        }
        showOverlay();
        fetch("/action?code=" + code)
          .then(handleResponse)
          .catch((err) => alert(err))
          .finally(() => refreshScreenshot(false));
      }

      window.addEventListener("beforeunload", cleanupStatusStream);

      refreshScreenshot(false);
      if (hasActiveSession()) {
        setupStatusStream();
      }
    </script>
  </body>
</html>
